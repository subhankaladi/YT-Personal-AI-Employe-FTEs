---
name: whatsapp-watcher
description: |
  Monitor WhatsApp Web for new messages containing specific keywords.
  Uses Playwright for browser automation to interact with WhatsApp Web.
  Creates action files in Obsidian vault's /Needs_Action folder for urgent messages.
  WARNING: Respect WhatsApp's Terms of Service. Use at your own risk.
---

# WhatsApp Watcher Skill

Monitor WhatsApp Web for messages containing keywords like "urgent", "invoice", "payment", etc.

## ⚠️ Important Warning

**Use this skill responsibly:**
- This uses WhatsApp Web automation which may violate WhatsApp's Terms of Service
- Only use for personal automation on your own accounts
- Do not use for spam or bulk messaging
- Consider using WhatsApp Business API for commercial use cases

## Prerequisites

### 1. Install Playwright

```bash
pip install playwright
playwright install chromium
```

### 2. Install Dependencies

```bash
pip install playwright
```

## Configuration

Create a config file at `vault_path/scripts/whatsapp_config.json`:

```json
{
  "session_path": "C:\\Users\\YourName\\whatsapp_session",
  "check_interval": 30,
  "keywords": ["urgent", "asap", "invoice", "payment", "help", "pricing"],
  "quiet_hours": {
    "start": 22,
    "end": 6
  }
}
```

## Usage

### Basic Usage

```bash
python whatsapp_watcher.py /path/to/vault
```

### First Time Setup

The first time you run it, you'll need to scan the QR code:

1. Run the watcher
2. WhatsApp Web QR code will appear in browser
3. Scan with your phone
4. Session will be saved for future runs

### With Custom Config

```bash
python whatsapp_watcher.py /path/to/vault --config /path/to/config.json
```

## Output Format

Creates markdown files in `/Needs_Action/`:

```markdown
---
type: whatsapp_message
from: +1234567890
chat: John Doe
received: 2026-02-24T10:30:00Z
priority: high
status: pending
keywords_matched: urgent, invoice
---

# WhatsApp Message

**From:** John Doe (+1234567890)  
**Chat:** Individual  
**Received:** 2026-02-24 10:30:00

---

## Message Content

Hey, can you send me the invoice urgently?

---

# Suggested Actions
- [ ] Reply to message
- [ ] Process invoice request
- [ ] Follow up if needed

---
*Generated by WhatsApp Watcher v0.1 (Silver Tier)*
```

## Architecture

```
┌─────────────┐     ┌──────────────┐     ┌──────────────────┐
│ WhatsApp    │────▶│ WhatsApp     │────▶│ Needs_Action/    │
│ Web         │     │ Watcher      │     │ WHATSAPP_*.md    │
│ (Playwright)│     │ (Python)     │     │                  │
└─────────────┘     └──────────────┘     └──────────────────┘
```

## How It Works

1. **Launches** Chromium with persistent context
2. **Navigates** to web.whatsapp.com
3. **Waits** for chat list to load
4. **Finds** unread messages with keywords
5. **Creates** action file for each match
6. **Saves** session for next run (no re-scan)

## Keywords Matching

Default keywords that trigger action files:
- `urgent`
- `asap`
- `invoice`
- `payment`
- `help`
- `pricing`

Customize in config:

```json
{
  "keywords": ["your", "custom", "keywords"]
}
```

## Quiet Hours

To avoid notifications during night:

```json
{
  "quiet_hours": {
    "start": 22,  // 10 PM
    "end": 6      // 6 AM
  }
}
```

## Security Notes

- **Session data** is stored locally - protect it
- **Never commit** session files to git
- **Log out** from WhatsApp Web when not in use
- **Monitor** for unusual account activity

## Troubleshooting

| Issue | Solution |
|-------|----------|
| QR code shows every time | Session not saving - check session_path permissions |
| No messages detected | Ensure messages are unread, check keywords |
| Browser crashes | Update Playwright: `pip install -U playwright` |
| WhatsApp bans account | Stop using immediately - against ToS |

## Code Example

```python
from playwright.sync_api import sync_playwright
from base_watcher import BaseWatcher
from pathlib import Path
import time

class WhatsAppWatcher(BaseWatcher):
    def __init__(self, vault_path: str, session_path: str, 
                 keywords: list = None, check_interval: int = 30):
        super().__init__(vault_path, check_interval)
        self.session_path = Path(session_path)
        self.keywords = keywords or ['urgent', 'asap', 'invoice']
        
    def check_for_updates(self) -> list:
        """Check WhatsApp Web for new messages with keywords."""
        with sync_playwright() as p:
            # Launch with persistent context (saves session)
            browser = p.chromium.launch_persistent_context(
                self.session_path,
                headless=True,
                args=['--disable-blink-features=AutomationControlled']
            )
            
            page = browser.pages[0]
            page.goto('https://web.whatsapp.com')
            
            # Wait for chat list
            page.wait_for_selector('[data-testid="chat-list"]', timeout=30000)
            
            # Find unread chats
            unread = page.query_selector_all('[aria-label*="unread"]')
            
            messages = []
            for chat in unread:
                text = chat.inner_text().lower()
                
                # Check for keywords
                matched = [kw for kw in self.keywords if kw in text]
                if matched:
                    messages.append({
                        'text': chat.inner_text(),
                        'chat': chat,
                        'keywords': matched
                    })
            
            browser.close()
            return messages
    
    def create_action_file(self, message) -> Path:
        """Create markdown action file for WhatsApp message."""
        # Parse message content
        lines = message['text'].split('\n')
        sender = lines[0] if lines else 'Unknown'
        body = '\n'.join(lines[1:]) if len(lines) > 1 else ''
        
        content = f'''---
type: whatsapp_message
from: {sender}
received: {datetime.now().isoformat()}
priority: high
status: pending
keywords_matched: {', '.join(message['keywords'])}
---

# WhatsApp Message

**From:** {sender}  
**Received:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

---

## Message Content

{body}

---

# Suggested Actions
- [ ] Reply to message
- [ ] Take required action
- [ ] Follow up if needed

---
*Generated by WhatsApp Watcher v0.1*
'''
        filepath = self.needs_action / f'WHATSAPP_{int(time.time())}.md'
        filepath.write_text(content)
        return filepath
```

## Alternative: WhatsApp Business API

For production use, consider the official WhatsApp Business API:

1. [WhatsApp Business Platform](https://business.whatsapp.com/)
2. Use Meta's Graph API
3. Official and ToS-compliant
4. Supports webhooks for real-time notifications

## Next Steps

After setting up WhatsApp Watcher:
1. Configure orchestrator to process message action files
2. Set up approval workflow for replies
3. Create canned responses for common queries
4. Add sentiment analysis for priority routing
