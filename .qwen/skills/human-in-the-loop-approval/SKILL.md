---
name: human-in-the-loop-approval
description: |
  Human-in-the-Loop (HITL) approval workflow for sensitive actions.
  Creates approval request files in /Pending_Approval, waits for human
  decision (move to /Approved or /Rejected), then executes or cancels.
  Supports expiration, audit logging, and approval thresholds.
---

# Human-in-the-Loop Approval Workflow

Require human approval for sensitive actions before execution.

## Overview

The HITL workflow ensures humans review and approve sensitive actions:
- Sending emails to new contacts
- Payments over threshold
- Social media posts
- Any action with risk

## Folder Structure

```
AI_Employee_Vault/
├── Pending_Approval/     # Awaiting human decision
├── Approved/             # Approved, ready to execute
├── Rejected/             # Rejected, with comments
└── Done/                 # Completed actions
```

## Approval Request Schema

```markdown
---
type: approval_request
action: email_send
to: client@example.com
subject: Invoice #001
amount: 1500.00
created: 2026-02-24T10:30:00Z
expires: 2026-02-25T10:30:00Z
status: pending
priority: normal
---

# Approval Required: [Action Description]

## Details

| Field | Value |
|-------|-------|
| Action | email_send |
| To | client@example.com |
| Subject | Invoice #001 |
| Amount | $1,500.00 |

## Content

Email body or action details here...

## Why Approval Required

- New contact (first time emailing)
- Contains attachment
- Amount exceeds auto-approve threshold

---

## To Approve
Move this file to `/Approved` folder.

## To Reject
Move this file to `/Rejected` folder and add a comment explaining why.

## Expiration
This approval request expires on 2026-02-25 at 10:30 AM.
Expired requests will be automatically rejected.

---
*Generated by AI Employee v0.1 (Silver Tier)*
```

## Approval Thresholds

Configure in `Company_Handbook.md`:

```markdown
## Approval Thresholds

| Action Type | Auto-Approve | Requires Approval |
|-------------|--------------|-------------------|
| Email to known contact | Yes | No |
| Email to new contact | No | Yes |
| Payment < $50 | Yes | No |
| Payment ≥ $50 | No | Yes |
| Social media post | No | Yes (always) |
| File delete | No | Yes (always) |
```

## Workflow Steps

### 1. AI Detects Action Need

```
Qwen Code reads action file and determines action needed
```

### 2. Check if Approval Required

```python
def requires_approval(action_type, details):
    if action_type == 'email_send':
        if details['to'] not in known_contacts:
            return True
        if details.get('attachment'):
            return True
    if action_type == 'payment':
        if details['amount'] >= 50:
            return True
    return False
```

### 3. Create Approval Request

```
Qwen Code creates file in /Pending_Approval/
```

### 4. Human Reviews

```
User reads approval request, considers:
- Is this action appropriate?
- Are details correct?
- Any red flags?
```

### 5. Human Decides

**Approve:** Move file to `/Approved`  
**Reject:** Move file to `/Rejected`, add comment

### 6. Orchestrator Executes

```
Orchestrator detects file in /Approved
Triggers Qwen Code to execute action
Moves result to /Done
```

## Implementation

### Python: Approval Manager

```python
from pathlib import Path
from datetime import datetime
import shutil

class ApprovalManager:
    def __init__(self, vault_path: Path):
        self.vault = vault_path
        self.pending = vault_path / 'Pending_Approval'
        self.approved = vault_path / 'Approved'
        self.rejected = vault_path / 'Rejected'
        self.done = vault_path / 'Done'
        self.logs = vault_path / 'Logs'
    
    def create_approval_request(self, action_type: str, details: dict,
                                reason: str, expires_hours: int = 24) -> Path:
        """Create approval request file."""
        now = datetime.now()
        expires = datetime.now() + timedelta(hours=expires_hours)
        
        content = f'''---
type: approval_request
action: {action_type}
created: {now.isoformat()}
expires: {expires.isoformat()}
status: pending
---

# Approval Required: {action_type}

## Details
{self._format_details(details)}

## Why Approval Required
{reason}

---
Move to /Approved to approve, /Rejected to deny.
Expires: {expires.strftime('%Y-%m-%d %H:%M')}
'''
        filepath = self.pending / f'APPROVAL_{action_type}_{int(now.timestamp())}.md'
        filepath.write_text(content)
        return filepath
    
    def check_expirations(self):
        """Move expired approvals to Rejected."""
        for filepath in self.pending.glob('*.md'):
            content = filepath.read_text()
            if 'expires:' in content:
                # Parse expiration
                expires = self._parse_expiration(content)
                if expires and datetime.now() > expires:
                    # Add expiration notice
                    content += f'\n\n**EXPIRED:** {expires.isoformat()}'
                    dest = self.rejected / filepath.name
                    filepath.rename(dest)
                    self._log_action('approval_expired', str(filepath))
    
    def process_approved(self) -> list:
        """Process all approved actions."""
        results = []
        for filepath in self.approved.glob('*.md'):
            result = self._execute_action(filepath)
            results.append(result)
            # Move to Done
            dest = self.done / filepath.name
            filepath.rename(dest)
        return results
    
    def _execute_action(self, filepath: Path) -> dict:
        """Execute the approved action."""
        content = filepath.read_text()
        # Parse action type and details
        # Execute via Qwen Code or direct action
        return {'file': str(filepath), 'status': 'executed'}
    
    def _log_action(self, action_type: str, details: str):
        """Log action for audit."""
        log_file = self.logs / f'{datetime.now().strftime("%Y-%m-%d")}.jsonl'
        entry = {
            'timestamp': datetime.now().isoformat(),
            'action': action_type,
            'details': details
        }
        with open(log_file, 'a') as f:
            f.write(json.dumps(entry) + '\n')
```

### Orchestrator Integration

```python
def run_approval_loop(self):
    """Continuously check for approvals to process."""
    while True:
        # Check for expired approvals
        self.approval_manager.check_expirations()
        
        # Process newly approved items
        results = self.approval_manager.process_approved()
        
        for result in results:
            self.logger.info(f"Executed: {result['file']}")
        
        time.sleep(30)  # Check every 30 seconds
```

## Audit Logging

All approval actions logged to `/Logs/YYYY-MM-DD.jsonl`:

```json
{"timestamp": "2026-02-24T10:30:00Z", "action": "approval_created", "details": "APPROVAL_email_send_1234.md"}
{"timestamp": "2026-02-24T11:00:00Z", "action": "approval_approved", "details": "APPROVAL_email_send_1234.md"}
{"timestamp": "2026-02-24T11:01:00Z", "action": "action_executed", "details": "Email sent to client@example.com"}
{"timestamp": "2026-02-24T11:02:00Z", "action": "approval_completed", "details": "APPROVAL_email_send_1234.md -> Done/"}
```

## Approval Types

### Email Send

```markdown
---
type: approval_request
action: email_send
to: client@example.com
subject: Invoice #001
has_attachment: true
---
```

### Payment

```markdown
---
type: approval_request
action: payment
amount: 500.00
recipient: Vendor Name
reference: Invoice #1234
---
```

### Social Media Post

```markdown
---
type: approval_request
action: social_post
platform: linkedin
content: Just completed project...
scheduled: 2026-02-24T09:00:00Z
---
```

### File Operation

```markdown
---
type: approval_request
action: file_delete
path: /path/to/file.txt
reason: Cleanup old files
---
```

## Best Practices

1. **Clear reasons**: Explain why approval is needed
2. **Expiration**: Set reasonable deadlines (24-48 hours)
3. **Audit trail**: Log all approval decisions
4. **Rejection feedback**: Add comments when rejecting
5. **Priority handling**: Urgent items get faster review
6. **Regular review**: Check pending approvals daily

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Approvals not processed | Check orchestrator is running |
| Files stuck in Approved | Verify Qwen Code execution works |
| Too many approvals | Review thresholds in Company_Handbook |
| Expired approvals | Extend expiration or re-create request |

## Next Steps

1. Configure approval thresholds for your needs
2. Set up notification for new approvals (email/SMS)
3. Create approval templates for common actions
4. Add approval analytics (avg response time, etc.)
